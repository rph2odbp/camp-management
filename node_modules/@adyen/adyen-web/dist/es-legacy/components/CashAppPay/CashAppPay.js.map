{"version":3,"file":"CashAppPay.js","sources":["../../../../src/components/CashAppPay/CashAppPay.tsx"],"sourcesContent":["import { h } from 'preact';\nimport UIElement from '../internal/UIElement/UIElement';\nimport { CoreProvider } from '../../core/Context/CoreProvider';\nimport { CashAppComponent } from './components/CashAppComponent';\nimport CashAppService from './services/CashAppService';\nimport { CashAppSdkLoader } from './services/CashAppSdkLoader';\nimport { CashAppPayElementData, CashAppPayConfiguration, CashAppPayEventData } from './types';\nimport { ICashAppService } from './services/types';\nimport defaultProps from './defaultProps';\nimport RedirectButton from '../internal/RedirectButton';\nimport { payAmountLabel } from '../internal/PayButton';\nimport { TxVariants } from '../tx-variants';\nimport type { ICore } from '../../core/types';\nimport { PREFIX } from '../internal/Icon/constants';\n\nexport class CashAppPay extends UIElement<CashAppPayConfiguration> {\n    public static type = TxVariants.cashapp;\n\n    private readonly cashAppService: ICashAppService | undefined;\n\n    protected static defaultProps = defaultProps;\n\n    constructor(checkout: ICore, props?: CashAppPayConfiguration) {\n        super(checkout, props);\n\n        if (this.props.enableStoreDetails && this.props.storePaymentMethod) {\n            console.warn(\n                'CashAppPay: enableStoreDetails AND storePaymentMethod configuration properties should not be used together. That can lead to undesired behavior.'\n            );\n        }\n\n        if (this.props.storedPaymentMethodId) {\n            return;\n        }\n\n        this.cashAppService = new CashAppService(new CashAppSdkLoader(), {\n            storePaymentMethod: this.props.storePaymentMethod,\n            useCashAppButtonUi: this.props.showPayButton,\n            environment: this.props.environment,\n            amount: this.props.amount,\n            redirectURL: this.props.redirectURL,\n            clientId: this.props.configuration?.clientId,\n            scopeId: this.props.configuration?.scopeId,\n            button: this.props.button,\n            referenceId: this.props.referenceId\n        });\n    }\n\n    public formatProps(props: CashAppPayConfiguration) {\n        return {\n            ...props,\n            enableStoreDetails: props.session?.configuration?.enableStoreDetails || props.enableStoreDetails\n        };\n    }\n\n    public formatData(): CashAppPayElementData {\n        const { shopperWantsToStore, grantId, onFileGrantId, cashTag, customerId } = this.state.data || {};\n        const { storePaymentMethod: storePaymentMethodSetByMerchant, storedPaymentMethodId } = this.props;\n\n        /**\n         * We include 'storePaymentMethod' flag if we either Display the Checkbox OR if it is non-sessions flow AND the merchant wants to store the payment method\n         */\n        const includeStorePaymentMethod = this.props.enableStoreDetails || (!this.props.session && storePaymentMethodSetByMerchant);\n\n        if (storedPaymentMethodId) {\n            return {\n                paymentMethod: {\n                    type: CashAppPay.type,\n                    storedPaymentMethodId\n                }\n            };\n        }\n\n        const shouldAddOnFileProperties = onFileGrantId && cashTag;\n\n        return {\n            paymentMethod: {\n                type: CashAppPay.type,\n                ...(grantId && { grantId }),\n                ...(customerId && { customerId }),\n                ...(shouldAddOnFileProperties && { onFileGrantId, cashtag: cashTag })\n            },\n            ...(includeStorePaymentMethod && { storePaymentMethod: storePaymentMethodSetByMerchant || shopperWantsToStore })\n        };\n    }\n\n    get displayName() {\n        if (this.props.storedPaymentMethodId && this.props.cashtag) {\n            return this.props.cashtag;\n        }\n        return this.props.name;\n    }\n\n    get additionalInfo() {\n        return this.props.storedPaymentMethodId ? 'Cash App Pay' : '';\n    }\n\n    public submit = () => {\n        const { onClick, storedPaymentMethodId } = this.props;\n\n        if (storedPaymentMethodId) {\n            super.submit();\n            return;\n        }\n\n        let onClickPromiseRejected = false;\n\n        new Promise<void>((resolve, reject) => onClick({ resolve, reject }))\n            .catch(() => {\n                onClickPromiseRejected = true;\n                throw Error('onClick rejected');\n            })\n            .then(() => {\n                return this.cashAppService.createCustomerRequest();\n            })\n            .then(() => {\n                this.cashAppService.begin();\n            })\n            .catch(error => {\n                if (onClickPromiseRejected) {\n                    // Swallow exception triggered by onClick reject\n                    return;\n                }\n                this.handleError(error);\n            });\n    };\n\n    public get isValid(): boolean {\n        return true;\n    }\n\n    private handleOnChangeStoreDetails = (storePayment: boolean) => {\n        const data = { ...this.state.data, shopperWantsToStore: storePayment };\n        this.setState({ data });\n    };\n\n    private handleAuthorize = (cashAppPaymentData: CashAppPayEventData): void => {\n        const data = { ...this.state.data, ...cashAppPaymentData };\n        this.setState({ data, valid: {}, errors: {}, isValid: true });\n        super.submit();\n    };\n\n    render() {\n        return (\n            <CoreProvider i18n={this.props.i18n} resources={this.resources} loadingContext={this.props.loadingContext}>\n                {this.props.storedPaymentMethodId ? (\n                    <RedirectButton\n                        showPayButton={this.props.showPayButton}\n                        label={payAmountLabel(this.props.i18n, this.props.amount)}\n                        icon={this.resources?.getImage({ imageFolder: 'components/' })(`${PREFIX}lock`)}\n                        name={this.displayName}\n                        amount={this.props.amount}\n                        payButton={this.payButton}\n                        onSubmit={this.submit}\n                        ref={ref => {\n                            this.componentRef = ref;\n                        }}\n                    />\n                ) : (\n                    <CashAppComponent\n                        ref={ref => {\n                            this.componentRef = ref;\n                        }}\n                        enableStoreDetails={this.props.enableStoreDetails}\n                        cashAppService={this.cashAppService}\n                        onChangeStoreDetails={this.handleOnChangeStoreDetails}\n                        onError={this.handleError}\n                        onClick={this.submit}\n                        onAuthorize={this.handleAuthorize}\n                    />\n                )}\n            </CoreProvider>\n        );\n    }\n}\n\nexport default CashAppPay;\n"],"names":["CashAppPay","UIElement","formatProps","props","_object_spread_props","_object_spread","enableStoreDetails","session","configuration","formatData","shopperWantsToStore","grantId","onFileGrantId","cashTag","customerId","this","state","data","storePaymentMethod","storePaymentMethodSetByMerchant","storedPaymentMethodId","includeStorePaymentMethod","paymentMethod","type","cashtag","displayName","name","additionalInfo","isValid","render","_this_resources","h","CoreProvider","i18n","resources","loadingContext","RedirectButton","showPayButton","label","payAmountLabel","amount","icon","getImage","imageFolder","PREFIX","payButton","onSubmit","submit","ref","componentRef","CashAppComponent","cashAppService","onChangeStoreDetails","handleOnChangeStoreDetails","onError","handleError","onClick","onAuthorize","handleAuthorize","constructor","checkout","_this_props_configuration","_this_props_configuration1","super","_define_property","onClickPromiseRejected","Promise","resolve","reject","catch","Error","then","createCustomerRequest","begin","error","storePayment","setState","cashAppPaymentData","valid","errors","console","warn","CashAppService","CashAppSdkLoader","useCashAppButtonUi","environment","redirectURL","clientId","scopeId","button","referenceId","TxVariants","cashapp","defaultProps"],"mappings":"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"}
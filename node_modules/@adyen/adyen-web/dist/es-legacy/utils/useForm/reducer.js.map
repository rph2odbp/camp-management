{"version":3,"file":"reducer.js","sources":["../../../../src/utils/useForm/reducer.ts"],"sourcesContent":["const omitKeys = (obj, omit) =>\n    Object.keys(obj)\n        .filter(k => !omit.includes(k))\n        .reduce((a, c) => {\n            a[c] = obj[c];\n            return a;\n        }, {});\n\nconst addKeys = (obj, add, initialValue, defaultData, pendingData) =>\n    add.reduce((a, c) => ({ ...a, [c]: a[c] ?? pendingData?.[c] ?? defaultData?.[c] ?? initialValue }), obj);\n\n/**\n * Processes default data and sets as default in state\n */\nexport function init({ schema, defaultData, processField, fieldProblems }) {\n    const getProcessedState = fieldKey => {\n        if (typeof defaultData[fieldKey] === 'undefined')\n            return { valid: false, errors: null, data: null, fieldProblems: fieldProblems?.[fieldKey] ?? null };\n\n        const [formattedValue, validationResult] = processField(\n            { key: fieldKey, value: defaultData[fieldKey], mode: 'blur' },\n            { state: { data: defaultData } }\n        );\n\n        return {\n            valid: (validationResult.isValid && !fieldProblems?.[fieldKey]) || false,\n            errors: validationResult.hasError() ? validationResult.getError() : null,\n            data: formattedValue,\n            fieldProblems: fieldProblems?.[fieldKey] ?? null\n        };\n    };\n\n    const formData = schema.reduce(\n        (acc: any, fieldKey) => {\n            const { valid, errors, data, fieldProblems } = getProcessedState(fieldKey);\n\n            return {\n                valid: { ...acc.valid, [fieldKey]: valid },\n                errors: { ...acc.errors, [fieldKey]: errors },\n                data: { ...acc.data, [fieldKey]: data },\n                fieldProblems: { ...acc.fieldProblems, [fieldKey]: fieldProblems }\n            };\n        },\n        { data: {}, valid: {}, errors: {}, fieldProblems: {} }\n    );\n\n    return {\n        schema,\n        data: formData.data,\n        valid: formData.valid,\n        errors: formData.errors,\n        fieldProblems: formData.fieldProblems\n    };\n}\n\nexport function getReducer(processField) {\n    return function reducer(state, { type, key, value, mode, schema, defaultData, formValue, selectedSchema, fieldProblems, data }) {\n        const validationSchema: string[] = selectedSchema || state.schema;\n\n        switch (type) {\n            case 'setData': {\n                return { ...state, data: { ...state['data'], [key]: value } };\n            }\n            case 'mergeData': {\n                return { ...state, data: { ...state['data'], ...data } };\n            }\n            case 'setValid': {\n                return { ...state, valid: { ...state['valid'], [key]: value } };\n            }\n            case 'setErrors': {\n                return { ...state, errors: { ...state['errors'], [key]: value } };\n            }\n            case 'setFieldProblems': {\n                return (\n                    state?.schema?.reduce(\n                        (acc, key) => ({\n                            ...acc,\n                            fieldProblems: { ...state['fieldProblems'], [key]: fieldProblems?.[key] ?? null },\n                            valid: { ...state['valid'], [key]: state['valid']?.[key] && !fieldProblems[key] }\n                        }),\n                        state\n                    ) ?? state\n                );\n            }\n            case 'updateField': {\n                const [formattedValue, validation] = processField({ key, value, mode }, { state });\n                const oldValue = state.data[key];\n                const fieldProblems = { ...state.fieldProblems };\n                if (oldValue !== formattedValue) {\n                    fieldProblems[key] = null;\n                }\n                return {\n                    ...state,\n                    data: { ...state['data'], [key]: formattedValue },\n                    errors: { ...state['errors'], [key]: validation.hasError() ? validation.getError() : null },\n                    valid: { ...state['valid'], [key]: (validation.isValid && !fieldProblems[key]) || false },\n                    fieldProblems\n                };\n            }\n            case 'mergeForm': {\n                // To provide a uniform result from forms even if there are multiple levels of nested forms are present\n                const mergedState = {\n                    ...state,\n                    data: { ...state['data'], ...formValue['data'] },\n                    errors: { ...state['errors'], ...formValue['errors'] },\n                    valid: { ...state['valid'], ...formValue['valid'] },\n                    fieldProblems: { ...state['fieldProblems'], ...formValue['fieldProblems'] }\n                };\n                if (mergedState['valid']) {\n                    mergedState.isValid = Object.values(mergedState.valid).every(isValid => isValid);\n                }\n                return mergedState;\n            }\n            case 'setSchema': {\n                const defaultState = init({ schema, defaultData, processField, fieldProblems });\n                const removedSchemaFields = state.schema.filter(x => !schema.includes(x));\n                const newSchemaFields = schema.filter(x => !state.schema.includes(x));\n\n                // if we remove a key from the schema we also lost the latest value of the field\n                // to prevent this we have to store the value in a local state so we can recover it when the key is re-added to the schema\n                const local = {\n                    data: omitKeys(state.data, newSchemaFields),\n                    errors: omitKeys(state.errors, newSchemaFields),\n                    valid: omitKeys(state.valid, newSchemaFields)\n                };\n\n                // reindex data and validation according to the new schema\n                const data = addKeys(omitKeys(state.data, removedSchemaFields), newSchemaFields, null, defaultState.data, state.local?.data);\n                const valid = addKeys(omitKeys(state.valid, removedSchemaFields), newSchemaFields, false, defaultState.valid, state.local?.valid);\n                const errors = addKeys(omitKeys(state.errors, removedSchemaFields), newSchemaFields, null, defaultState.errors, state.local?.errors);\n\n                return { ...state, schema, data, valid, errors, local };\n            }\n            case 'validateForm': {\n                const formValidation = validationSchema.reduce(\n                    (acc, cur) => {\n                        const [, validation] = processField({ key: cur, value: state.data[cur], mode: 'blur' }, { state });\n                        return {\n                            valid: { ...acc['valid'], [cur]: (validation.isValid && !state.fieldProblems[cur]) || false },\n                            errors: { ...acc['errors'], [cur]: validation.hasError(true) ? validation.getError(true) : null }\n                        };\n                    },\n                    { valid: state.valid, errors: state.errors }\n                );\n\n                return { ...state, valid: formValidation.valid, errors: formValidation.errors };\n            }\n            default:\n                throw new Error('Undefined useForm action');\n        }\n    };\n}\n"],"names":["omitKeys","obj","omit","Object","keys","filter","k","includes","reduce","a","c","addKeys","add","initialValue","defaultData","pendingData","_object_spread_props","_object_spread","init","schema","processField","fieldProblems","getProcessedState","fieldKey","valid","errors","data","formattedValue","validationResult","key","value","mode","state","isValid","hasError","getError","formData","acc","getReducer","type","formValue","selectedSchema","validationSchema","validation","oldValue","mergedState","values","every","defaultState","removedSchemaFields","x","newSchemaFields","local","formValidation","cur","Error"],"mappings":"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"}